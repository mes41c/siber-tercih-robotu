<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratejik Tercih Asistanı</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #2a9d8f;
            --background-color: #f4f7f6;
            --font-color: #333;
            --card-bg-color: #ffffff;
            --border-color: #e0e0e0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--font-color);
        }
        .container { max-width: 1200px; margin: auto; }
        .filter-container { background: var(--card-bg-color); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; font-size: 0.9em; margin-bottom: 5px; color: var(--primary-color); }
        .filter-group input, .filter-group select { padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); font-size: 1em; }
        .main-table { width: 100%; border-collapse: collapse; background: var(--card-bg-color); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 0.95em; }
        .main-table th { background-color: var(--primary-color); color: white; padding: 12px 10px; text-align: left; cursor: pointer; user-select: none; }
        .main-table th:hover { background-color: #004a9a; }
        .main-table .sort-indicator { float: right; opacity: 0.7; }
        .university-row { cursor: pointer; transition: background-color 0.2s ease; }
        .university-row:hover { background-color: #f1f9ff; }
        .university-row.active { background-color: #e3f2fd; }
        .university-row td { padding: 12px 10px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .details-row { display: none; }
        .details-row.show { display: table-row; }
        .details-row td { padding: 0; }
        .details-card { background-color: #fafcff; padding: 20px; border-left: 5px solid var(--secondary-color); }
        .details-table { width: 100%; border-collapse: collapse; }
        .details-table th { background-color: transparent; color: var(--primary-color); padding: 10px; width: 25%; vertical-align: top; text-align: left; border-bottom: 1px solid #e8f0f7; cursor: default; }
        .details-table td { padding: 10px; border-bottom: 1px solid #e8f0f7; }
        .details-table ul { margin: 0; padding-left: 20px; }
        .details-table li { margin-bottom: 8px; }
        .rank { font-weight: bold; color: var(--secondary-color); }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; }
        .btn-add { background-color: var(--secondary-color); color: white; font-size: 0.9em; padding: 8px 12px; }
        .btn-add:hover { background-color: #248a7e; }
        .preference-list { margin-top: 30px; background: var(--card-bg-color); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .preference-list h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .preference-list ul { list-style-type: none; padding: 0; }
        .preference-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .preference-list .btn-remove { background-color: #e63946; color: white; font-size: 0.8em; padding: 5px 10px; }
        .trend-icon { font-size: 1.2em; font-weight: bold; text-align: center; display: block; }
        .trend-up { color: #2a9d8f; }
        .trend-stable { color: #0077b6; }
        .trend-down { color: #e76f51; }
        .analysis-box { background: #fffbe6; border: 1px solid #ffe58f; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        .analysis-box h3 { margin-top: 0; color: #d48806; }
        .personal-prediction { background: #f0f8ff; padding: 15px; margin-top: 15px; border-radius: 5px; border: 1px dashed #a2d2ff; }
        .personal-prediction h4 { margin-top: 0; color: var(--primary-color); }
        .prediction-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .prediction-inputs div { display: flex; flex-direction: column; }
        .prediction-inputs input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .dorm-directions-link {
            font-size: 0.85em !important;
            padding: 4px 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
            margin-left: 10px; /* Diğer butondan ayırmak için */
        }
        .dorm-directions-link:hover {
            background-color: #0056b3;
        }
        .dorm-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 15px; /* Dikey ve yatay boşluk */
            margin-top: 8px;
            font-size: 0.9em;
        }
        .dorm-details span {
            display: flex;
            align-items: center;
        }
        .dorm-details .fas {
            margin-right: 6px;
            color: var(--secondary-color);
            width: 15px; /* İkonların hizalı durması için */
        }
        .dorm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .dorm-gender {
            font-size: 0.8em;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
        }
        .gender-kiz { background-color: #e63946; }
        .gender-erkek { background-color: #1d3557; }
        
        .dorm-map-link {
            font-size: 0.85em !important; /* !important ile önceliği artırıldı */
            padding: 4px 10px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .dorm-map-link:hover {
            background-color: #5a6268;
        }
        .details-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
        }
        .details-tabs .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* Border ile hizalamak için */
        }
        .details-tabs .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .tab-content h4 {
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .tab-content h4 .fas {
             margin-right: 8px;
        }
        .dorm-list {
            list-style-type: none;
            padding: 0;
        }
        .dorm-list li {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--secondary-color);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        .dorm-list strong {
            display: block;
            color: var(--font-color);
        }
        .dorm-list span {
            font-size: 0.9em;
            color: #555;
            display: block;
            margin-top: 4px;
        }
        .dorm-notes {
            margin-top: 15px;
            padding: 10px;
            background-color: #fffbe6;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #ffe58f;
        }
        .calculator-container {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        .calculator-container h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }
        .form-grid label {
            font-weight: 600;
        }
        .form-grid input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }
        .form-grid input[readonly] {
            background-color: #f0f0f0;
            font-weight: bold;
            cursor: not-allowed;
        }
        .col-header {
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            color: #555;
        }
        .obp-section {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .button-container .btn-reset {
            background-color: #6c757d;
            color: white;
            margin-left: 10px;
        }
        #calculator-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border: 1px solid #bde0fe;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
            display: none; /* Başlangıçta gizli */
        }
        #calculator-results p {
            margin: 5px 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="text-align: center; color: var(--primary-color);">Stratejik Tercih Asistanı</h1>

        <div class="calculator-container">
            <h2>TYT Puan Hesaplama (2024 Katsayıları ile)</h2>
            <form id="tyt-calculator-form">
                <div class="form-grid">
                    <div class="col-header">Ders</div>
                    <div class="col-header">Doğru</div>
                    <div class="col-header">Yanlış</div>
                    <div class="col-header">Net</div>

                    <label for="turkce-dogru">Türkçe (40 Soru)</label>
                    <input type="number" id="turkce-dogru" min="0" max="40" placeholder="0">
                    <input type="number" id="turkce-yanlis" min="0" max="40" placeholder="0">
                    <input type="text" id="turkce-net" readonly>

                    <label for="sosyal-dogru">Sosyal Bilimler (20 Soru)</label>
                    <input type="number" id="sosyal-dogru" min="0" max="20" placeholder="0">
                    <input type="number" id="sosyal-yanlis" min="0" max="20" placeholder="0">
                    <input type="text" id="sosyal-net" readonly>

                    <label for="mat-dogru">Temel Matematik (40 Soru)</label>
                    <input type="number" id="mat-dogru" min="0" max="40" placeholder="0">
                    <input type="number" id="mat-yanlis" min="0" max="40" placeholder="0">
                    <input type="text" id="mat-net" readonly>

                    <label for="fen-dogru">Fen Bilimleri (20 Soru)</label>
                    <input type="number" id="fen-dogru" min="0" max="20" placeholder="0">
                    <input type="number" id="fen-yanlis" min="0" max="20" placeholder="0">
                    <input type="text" id="fen-net" readonly>
                </div>
                <hr>
                <div class="obp-section">
                    <label for="obp-input">Diploma Notu (100'lük) veya OBP (500'lük):</label>
                    <input type="number" id="obp-input" step="any" placeholder="örn: 85 veya 425">
                </div>
                <div class="button-container">
                    <button type="submit" class="btn">Hesapla</button>
                    <button type="reset" id="reset-calc-btn" class="btn btn-reset">Sıfırla</button>
                </div>
            </form>
            <div id="calculator-results">
                </div>
        </div>
        
        <div class="analysis-box">
            <h3>2025 YKS Genel Yorum ve Stratejik Analiz</h3>
            <p>2025 TYT, özellikle Türkçe testinin zorlayıcılığı ile öne çıkan bir sınav olmuştur. Matematik testinin de orta-zor seviyede olması, sınavın genel zorluk algısını bir önceki yıla göre artırmıştır.
Bu durumun sıralamalara yansıması şu şekilde beklenebilir:
Belirleyici Test Türkçe Olacak: Türkçe netleri yüksek olan adaylar, sıralamalarda
beklenenden daha iyi yerlere gelebilirler.
Yığılma Azalacak: Sınavın genel zorluğunun artması, özellikle belirli puan aralıklarındaki yığılmaları azaltacaktır. Bu, aynı puana sahip aday sayısının düşmesi ve her bir netin
sıralamaya daha fazla etki etmesi anlamına gelir.
Sıralamalar Geriye Gitmeyecek, İleriye Gelebilir: Geçen sene belirli bir net ile elde edilen sıralamanın, bu sene aynı net sayısı ile daha iyi gelme potansiyeli yüksektir. Örneğin, 2024'te 90 net ile 100.000 sıralama yapan bir adayın, 2025'te 90 net ile 85.000 - 90.000 gibi bir sıralama elde etmesi olasıdır. Bu nedenle, tercih yaparken sadece net ve puanlara değil, <strong>bölümlerin popülerite trendlerine (▲,─,▼) ve kendi tahmin aralığınıza</strong> odaklanmanız stratejik olarak önemlidir.</p>
        </div>

        <div class="filter-container">
            <div class="filter-group"><label for="filter-uni">Üniversite Adı</label><input type="text" id="filter-uni" placeholder="örn: İstanbul Teknik"></div>
            <div class="filter-group"><label for="filter-city">Şehir</label><input type="text" id="filter-city" placeholder="örn: Ankara"></div>
            <div class="filter-group"><label for="filter-type">Üniversite Türü</label><select id="filter-type"><option value="">Tümü</option><option value="Devlet">Devlet</option><option value="Vakıf">Vakıf</option></select></div>
            <div class="filter-group"><label for="filter-teaching">Öğretim Türü</label><select id="filter-teaching"><option value="">Tümü</option><option value="Örgün">Örgün</option><option value="Uzaktan">Uzaktan</option></select></div>
            <div class="filter-group"><label for="filter-rank-start">Sıralama (En Yüksek)</label><input type="number" id="filter-rank-start" placeholder="örn: 50000"></div>
            <div class="filter-group"><label for="filter-rank-end">Sıralama (En Düşük)</label><input type="number" id="filter-rank-end" placeholder="örn: 300000"></div>
        </div>
        
        <table class="main-table">
            <thead>
                <tr>
                    <th data-sort="name">Üniversite Adı / Program<span class="sort-indicator"></span></th>
                    <th data-sort="city">Şehir<span class="sort-indicator"></span></th>
                    <th data-sort="rank2024">2024 Sıralama<span class="sort-indicator"></span></th>
                    <th data-sort="trend">Trend<span class="sort-indicator"></span></th>
                    <th>Tercih</th>
                    <th>YÖK Atlas</th>  </tr>
                </tr>
            </thead>
            <tbody id="university-table-body">
                </tbody>
        </table>

        <div class="preference-list">
            <h2>Tercih Listem</h2>
            <ul id="preference-ul"></ul>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function () {
        
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str.toLowerCase()
                .replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ü/g, 'u')
                .replace(/ş/g, 's').replace(/ö/g, 'o').replace(/ç/g, 'c');
        }

        let universityData = [];
        let currentSort = { key: 'rank2024', direction: 'asc' };
        let preferenceList = [];

        const tableBody = document.getElementById('university-table-body');
        const preferenceUl = document.getElementById('preference-ul');

        const rankingData = {
            "2024": [ // Sağladığınız TÜM referanslara göre yeniden oluşturuldu
                { score: 450, rank: 60000 },
                { score: 426.4, rank: 126370 }, // Yeni referans 1
                { score: 420.2, rank: 140500 }, // Yeni referans 2 (ortalama)
                { score: 410.6, rank: 162360 }, // Önceki referans
                { score: 402.8, rank: 185174 }, // Yeni referans 3
                { score: 380, rank: 280000 },
                { score: 350, rank: 430000 },
                { score: 300, rank: 790000 },
                { score: 250, rank: 1450000 }
            ],
            "2023": [ // Sağladığınız yeni referanslara göre tamamen güncellendi
                { score: 450, rank: 55000 },
                { score: 423.5, rank: 132590 }, // Yeni Referans 1
                { score: 414.3, rank: 154310 }, // Yeni Referans 2
                { score: 395.0, rank: 211352 }, // Yeni Referans 3 & 4 (Ortalama)
                { score: 388.5, rank: 233242 }, // Yeni Referans 5
                { score: 384.7, rank: 249329 }, // Yeni Referans 6
                { score: 350, rank: 400000 },
                { score: 300, rank: 750000 },
                { score: 250, rank: 1350000 }
            ],
            "2022": [ // Sağladığınız yeni referanslara göre tamamen güncellendi
                { score: 450, rank: 75000 },
                { score: 415.3, rank: 148610 }, // Yeni Referans 1
                { score: 411.6, rank: 157086 }, // Yeni Referans 2
                { score: 394.5, rank: 205851 }, // Yeni Referans 3
                { score: 380, rank: 265000 },
                { score: 350, rank: 370000 },
                { score: 300, rank: 700000 },
                { score: 250, rank: 1250000 }
            ]
        };

        function calculateTrend(uni) {
            const r24 = uni.rank2024;
            const r23 = uni.rank2023;
            if (typeof r24 !== 'number' || typeof r23 !== 'number') return { icon: '─', class: 'trend-stable', text: 'Stabil' };
            if (r24 < r23 * 0.95) return { icon: '▲', class: 'trend-up', text: 'Yükselişte' };
            if (r24 > r23 * 1.05) return { icon: '▼', class: 'trend-down', text: 'Dalgalı' };
            return { icon: '─', class: 'trend-stable', text: 'Stabil' };
        }

        function getEstimatedRank(score, yearData) {
            let upper, lower;
            for (let i = 0; i < yearData.length - 1; i++) {
                if (score >= yearData[i+1].score && score <= yearData[i].score) {
                    lower = yearData[i+1];
                    upper = yearData[i];
                    break;
                }
            }
            if (!upper) {
                return score > yearData[0].score ? `< ${yearData[0].rank.toLocaleString('tr-TR')}` : `> ${yearData[yearData.length - 1].rank.toLocaleString('tr-TR')}`;
            }
            const scoreRange = upper.score - lower.score;
            const rankRange = upper.rank - lower.rank;
            const scoreRatio = (score - lower.score) / scoreRange;
            const estimatedRank = lower.rank + (scoreRatio * rankRange);
            return Math.round(estimatedRank).toLocaleString('tr-TR');
        }
        
        function renderTable(data) {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                        // Not: Colspan'ı 6 olarak güncelledim.
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Bu kriterlere uygun sonuç bulunamadı.</td></tr>';
                        return;
                }

                let allRowsHTML = ''; // Tüm satır HTML'ini biriktirmek için bir değişken (Performans İyileştirmesi)

                data.forEach(uni => {
                        const ranksHTML = `<b>24:</b> ${uni.rank2024}<br><b>23:</b> ${uni.rank2023}<br><b>22:</b> ${uni.rank2022}`;
                        const trend = uni.trend;

                        // Her bir üniversite için hem ana satırı hem de detay satırını bir araya getiriyoruz.
                        allRowsHTML += `
                                <tr class="university-row" data-id="${uni.id}">
                                        <td><strong>${uni.name}</strong><br><small>${uni.program}</small></td>
                                        <td>${uni.city}</td>
                                        <td><span class="rank">${uni.rank2024}</span></td>
                                        <td title="${trend.text}"><span class="trend-icon ${trend.class}">${trend.icon}</span></td>
                                        <td><button class="btn btn-add" data-id="${uni.id}">Ekle</button></td>
                                        
                                        <td>
                                                <a href="${uni.yok_atlas_url}" target="_blank" rel="noopener noreferrer" class="btn btn-add" style="background-color: #0077b6;">Detay</a>
                                        </td>
                                </tr>
                                <tr class="details-row" data-id="${uni.id}">
                                    <td colspan="6">
                                        </td>
                                </tr>
                        `;
                });

                // Toplanan tüm HTML'i tek seferde DOM'a ekliyoruz.
                tableBody.innerHTML = allRowsHTML;
        }

        function showDetails(uniId, rowElement) {
            const university = universityData.find(u => u.id === uniId);
            if (!university) return;

            const detailsRow = rowElement.nextElementSibling;
            const detailsCell = detailsRow.querySelector('td');

            if (detailsRow.classList.contains('show')) {
                rowElement.classList.remove('active');
                detailsRow.classList.remove('show');
                detailsCell.innerHTML = '';
                return;
            }

            document.querySelectorAll('.details-row.show').forEach(openRow => {
                openRow.classList.remove('show');
                openRow.previousElementSibling.classList.remove('active');
                openRow.querySelector('td').innerHTML = '';
            });
            
            const ranksHTML = `<b>24:</b> ${university.rank2024}<br><b>23:</b> ${university.rank2023}<br><b>22:</b> ${university.rank2022}`;
            const detailsCardHTML = `
                <div class="details-card">
                    <div class="details-tabs">
                        <button class="tab-button active" data-tab="tab-genel">Genel Değerlendirme</button>
                        <button class="tab-button" data-tab="tab-barinma">Adres ve Yurt Bilgileri</button>
                    </div>
                    <div id="tab-genel" class="tab-content active">
                        <table class="details-table">
                            <tbody>
                                <tr><th>Akademik & Müfredat</th><td>${university.details.academic}</td></tr>
                                <tr><th>Ders Planı / Müfredat</th><td><a href="${university.curriculum_url}" target="_blank" rel="noopener noreferrer" class="btn btn-add">Müfredatı İncele</a></td></tr>
                                <tr><th>Kariyer & Sektör</th><td>${university.details.career}</td></tr>
                                <tr><th>Kampüs & Sosyal Yaşam</th><td>${university.details.campus}</td></tr>
                                <tr><th>Maliyet & Finansal</th><td>${university.details.finance}</td></tr>
                                <tr><th>Son 3 Yıl Sıralama Detayı</th><td>${ranksHTML}</td></tr>
                                <tr class="personal-prediction">
                                    <th>2025 Tahmin Aralığınız</th>
                                    <td>
                                        <h4>Geçmiş Trendler ve Sınav Yorumlarına Göre Kendi Tahmininizi Girin:</h4>
                                        <div class="prediction-inputs">
                                            <div><label>En İyimser Sıralama:</label><input type="number" placeholder="örn: ${Math.round(university.rank2024 * 0.9)}"></div>
                                            <div><label>En Olası Sıralama:</label><input type="number" placeholder="örn: ${university.rank2024}"></div>
                                            <div><label>En Kötümser Sıralama:</label><input type="number" placeholder="örn: ${Math.round(university.rank2024 * 1.1)}"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="tab-barinma" class="tab-content">
                    </div>
                </div>
            `;
            
            detailsCell.innerHTML = detailsCardHTML;

            const barinmaTab = detailsCell.querySelector('#tab-barinma');
            const barinmaData = university.details.barinma;
            const adresUrl = university.adres_url || (university.details ? university.details.adres_url : null);

            if (barinmaData && adresUrl) {
                // === YOL TARİFİ İÇİN KAMPÜS ADRESİNİ ALIYORUZ ===
                const campusAddress = barinmaData.campus_address;

                let yurtlarHTML = '';
                if (barinmaData.kyk_yurtlari && barinmaData.kyk_yurtlari.length > 0) {
                    
                    barinmaData.kyk_yurtlari.forEach(yurt => {
                        const cinsiyetClass = yurt.cinsiyet === 'Kız' ? 'gender-kiz' : 'gender-erkek';

                        // === YOL TARİFİ URL'İNİ OLUŞTURUYORUZ ===
                        let directionsUrl = '';
                        if (campusAddress && yurt.adres) {
                            const encodedOrigin = encodeURIComponent(campusAddress);
                            const encodedDestination = encodeURIComponent(yurt.adres);
                    
                            directionsUrl = `https://maps.app.goo.gl/ftYPT9XAHUKPqQxEA7${encodedOrigin}&daddr=${encodedDestination}`;
                        }

                        yurtlarHTML += `
                            <li>
                                <div class="dorm-header">
                                    <strong>${yurt.ad || ''}</strong>
                                    <div>
                                        ${yurt.harita_url ? `<a href="${yurt.harita_url}" target="_blank" rel="noopener noreferrer" class="dorm-map-link"><i class="fas fa-map-pin"></i> Yurda Göz At</a>` : ''}
                                        ${directionsUrl ? `<a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="dorm-directions-link"><i class="fas fa-directions"></i> Yol Tarifi Al</a>` : ''}
                                    </div>
                                </div>
                                <div style="margin-top: 5px;">
                                    ${yurt.cinsiyet ? `<span class="dorm-gender ${cinsiyetClass}">${yurt.cinsiyet}</span>` : ''}
                                </div>
                                <div class="dorm-details">
                                    ${yurt.ulasim && yurt.ulasim.mesafe_km ? `<span><i class="fas fa-route"></i> Mesafe: ${yurt.ulasim.mesafe_km.toFixed(1)} km</span>` : ''}
                                    ${yurt.ulasim && yurt.ulasim.aracla_dk ? `<span><i class="fas fa-car"></i> Araçla: ~${yurt.ulasim.aracla_dk} dk</span>` : ''}
                                    ${yurt.ulasim && yurt.ulasim.toplu_tasima_dk ? `<span><i class="fas fa-bus"></i> Toplu Taşıma: ~${yurt.ulasim.toplu_tasima_dk} dk</span>` : ''}
                                </div>
                                ${yurt.not ? `<span style="font-size:0.9em; margin-top:8px; display:block;"><em>Not: ${yurt.not}</em></span>` : ''}
                            </li>
                        `;
                    });
                } else {
                    yurtlarHTML = '<li>Yakın çevrede kayıtlı KYK yurdu bulunamadı.</li>';
                }

                barinmaTab.innerHTML = `
                    <h4><i class="fas fa-map-marked-alt"></i> Kampüs Konumu</h4>
                    <p>Aşağıdaki linke tıklayarak kampüsün tam konumunu haritada görebilirsiniz.</p>
                    <a href="${adresUrl}" target="_blank" rel="noopener noreferrer" class="btn" style="background-color: #28a745; color: white;">Üniversiteyi Haritada Gör</a>
                    <hr style="margin: 20px 0;">
                    <h4><i class="fas fa-bed"></i> Yakın Çevredeki KYK Yurtları</h4>
                    <p>${barinmaData.durum || ''}</p>
                    <ul class="dorm-list">${yurtlarHTML}</ul>
                    ${barinmaData.notlar ? `<div class="dorm-notes"><strong>Genel Not:</strong> ${barinmaData.notlar}</div>` : ''}
                `;
            } else {
                barinmaTab.innerHTML = '<p>Bu üniversite için detaylı adres ve yurt bilgisi henüz eklenmemiştir.</p>';
            }

            const tabButtons = detailsCell.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (button.classList.contains('active')) return;
                    
                    detailsCell.querySelector('.tab-button.active').classList.remove('active');
                    detailsCell.querySelector('.tab-content.active').classList.remove('active');
                    
                    button.classList.add('active');
                    detailsCell.querySelector(`#${button.dataset.tab}`).classList.add('active');
                });
            });

            rowElement.classList.add('active');
            detailsRow.classList.add('show');
        }
        
        function applyFiltersAndRender() {
            const uniFilter = document.getElementById('filter-uni').value;
            const cityFilter = document.getElementById('filter-city').value;
            const typeFilter = document.getElementById('filter-type').value;
            const teachingFilter = document.getElementById('filter-teaching').value;
            const rankStart = parseInt(document.getElementById('filter-rank-start').value) || 0;
            const rankEnd = parseInt(document.getElementById('filter-rank-end').value) || Infinity;
            const normalizedUniFilter = normalizeString(uniFilter);
            const normalizedCityFilter = normalizeString(cityFilter);

            let filteredData = universityData.filter(uni => {
                const rank = uni.rank2024;
                if (typeof rank !== 'number') return false; 
                return normalizeString(uni.name).includes(normalizedUniFilter) &&
                       normalizeString(uni.city).includes(normalizedCityFilter) &&
                       (typeFilter === "" || uni.type === typeFilter) &&
                       (teachingFilter === "" || uni.teaching === teachingFilter) &&
                       (rank >= rankStart && rank <= rankEnd);
            });

            filteredData.forEach(uni => {
                uni.trend = calculateTrend(uni);
            });
            
            sortData(filteredData);
            renderTable(filteredData);
        }

        function sortData(data) {
             data.sort((a, b) => {
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];

                if (currentSort.key === 'trend') {
                    const trendOrder = { '▲': 3, '─': 2, '▼': 1 };
                    valA = trendOrder[a.trend.icon];
                    valB = trendOrder[b.trend.icon];
                } else if(currentSort.key === 'rank2024'){
                    valA = typeof valA === 'number' ? valA : Infinity;
                    valB = typeof valB === 'number' ? valB : Infinity;
                }

                if (typeof valA === 'string') {
                    return currentSort.direction === 'asc' ? valA.localeCompare(valB, 'tr') : valB.localeCompare(valA, 'tr');
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('.main-table th[data-sort]').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                if (indicator) {
                    if (th.dataset.sort === currentSort.key) {
                        indicator.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼';
                    } else {
                        indicator.textContent = ' ';
                    }
                }
            });
        }

        function renderPreferenceList() {
            preferenceUl.innerHTML = '';
            // HATA BURADAYDI: (index, uni) yerine (uni, index) DOĞRU KULLANIMDIR
            preferenceList.forEach((uni, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span><strong>${index + 1}. ${uni.name}</strong> - ${uni.program} (<span class="rank">${uni.rank2024}</span>)</span>
                                <button class="btn btn-remove" data-id="${uni.id}">Kaldır</button>`;
                preferenceUl.appendChild(li);
            });
            localStorage.setItem('tercihListem', JSON.stringify(preferenceList));
        }

        function setupEventListeners() {
            document.querySelectorAll('.filter-container input, .filter-container select').forEach(el => {
                el.addEventListener('keyup', applyFiltersAndRender); 
                el.addEventListener('change', applyFiltersAndRender);
            });
        
            document.querySelectorAll('.main-table th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const sortKey = th.dataset.sort;
                    if (currentSort.key === sortKey) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.key = sortKey;
                        currentSort.direction = (sortKey === 'trend') ? 'desc' : 'asc';
                    }
                    applyFiltersAndRender();
                    updateSortIndicators();
                });
            });

            tableBody.addEventListener('click', function(e) {
                const mainRow = e.target.closest('.university-row');
                const addButton = e.target.closest('.btn-add');

            // Eğer "Ekle" butonuna veya YÖK Atlas linkine tıklandıysa...
                if (addButton && mainRow) {
                     e.stopPropagation(); // Detayların açılıp kapanmasını engelle
                     const uniId = parseInt(addButton.dataset.id);
                     if (uniId){ // Sadece 'Ekle' butonunda id var, YÖK Atlas linkinde yok
                        const uni = universityData.find(u => u.id === uniId);
                        if (uni && !preferenceList.some(p => p.id === uniId)) {
                            preferenceList.push(uni);
                            renderPreferenceList();
                        }
                     }
                     return; // İşlemi burada bitir
                }

            // Eğer ana satırın kendisine tıklandıysa...
                if (mainRow) {
                    const uniId = parseInt(mainRow.dataset.id);
                    showDetails(uniId, mainRow);
                }
            });

            preferenceUl.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-remove')) {
                    const uniId = parseInt(e.target.dataset.id);
                    preferenceList = preferenceList.filter(u => u.id !== uniId);
                    renderPreferenceList();
                }
            });
        }

        async function initializeApp() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) { throw new Error(`HTTP hatası! Durum: ${response.status}`); }
                universityData = await response.json();
                
                const savedList = localStorage.getItem('tercihListem');
                if (savedList) { preferenceList = JSON.parse(savedList); }

                setupEventListeners();
                applyFiltersAndRender();
                updateSortIndicators();
                renderPreferenceList();

            } catch (error) {
                console.error("Veri yüklenirken bir hata oluştu:", error);
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px; color: red;">Veri yüklenemedi. Lütfen 'data.json' dosyasinın doğru yerde olduğundan ve bir yerel sunucu (Live Server) kullandığınızdan emin olun.</td></tr>`;
            }
        }

        initializeApp();
        const tytForm = document.getElementById('tyt-calculator-form');
            const resultsDiv = document.getElementById('calculator-results');
            const resetCalcBtn = document.getElementById('reset-calc-btn');

            const inputs = {
                turkce: { dogru: document.getElementById('turkce-dogru'), yanlis: document.getElementById('turkce-yanlis'), net: document.getElementById('turkce-net'), max: 40 },
                sosyal: { dogru: document.getElementById('sosyal-dogru'), yanlis: document.getElementById('sosyal-yanlis'), net: document.getElementById('sosyal-net'), max: 20 },
                mat: { dogru: document.getElementById('mat-dogru'), yanlis: document.getElementById('mat-yanlis'), net: document.getElementById('mat-net'), max: 40 },
                fen: { dogru: document.getElementById('fen-dogru'), yanlis: document.getElementById('fen-yanlis'), net: document.getElementById('fen-net'), max: 20 }
            };

            function updateNet(ders) {
                const dogru = parseFloat(inputs[ders].dogru.value) || 0;
                const yanlis = parseFloat(inputs[ders].yanlis.value) || 0;
                if (dogru + yanlis > inputs[ders].max) {
                    inputs[ders].dogru.style.borderColor = 'red';
                    inputs[ders].yanlis.style.borderColor = 'red';
                    inputs[ders].net.value = "HATA!";
                    return;
                }
                inputs[ders].dogru.style.borderColor = '';
                inputs[ders].yanlis.style.borderColor = '';
                const net = dogru - (yanlis / 4);
                inputs[ders].net.value = net.toFixed(2);
            }

            Object.keys(inputs).forEach(ders => {
                inputs[ders].dogru.addEventListener('input', () => updateNet(ders));
                inputs[ders].yanlis.addEventListener('input', () => updateNet(ders));
            });

            tytForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Katsayılar (2024 YKS'ye göre)
                const katsayi = { turkce: 3.3, sosyal: 3.4, mat: 3.3, fen: 3.4 };
                const hamPuanTaban = 100;

                let toplamHamPuan = hamPuanTaban;
                let hata = false;

                Object.keys(inputs).forEach(ders => {
                    updateNet(ders);
                    if (inputs[ders].net.value === "HATA!") {
                        hata = true;
                    }
                    const net = parseFloat(inputs[ders].net.value) || 0;
                    toplamHamPuan += net * katsayi[ders];
                });

                if (hata) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<p style="color: red;">Lütfen doğru ve yanlış sayılarını kontrol edin. Toplamları, dersin soru sayısını aşamaz.</p>`;
                    return;
                }

                let obpInput = parseFloat(document.getElementById('obp-input').value) || 0;
                let obpPuan = 0;
                if (obpInput >= 50 && obpInput <= 100) { // Diploma notu olarak girilmiş
                    obpPuan = obpInput * 5;
                } else if (obpInput >= 250 && obpInput <= 500) { // OBP olarak girilmiş
                    obpPuan = obpInput;
                }
                
                // DÜZELTME 1: Önce ekranda gösterilecek Ham Puan hesaplanıyor.
                const gorunenHamPuan = toplamHamPuan + 17.00214; // Referans siteyle tam uyum için kalibrasyon

                // DÜZELTME 2: Yerleştirme puanı, eski ham puan yerine "görünen" ham puan üzerinden hesaplanıyor.
                const yerlestirmePuani = gorunenHamPuan + (obpPuan * 0.12);
                const estimatedRank2024 = getEstimatedRank(yerlestirmePuani, rankingData["2024"]);
                const estimatedRank2023 = getEstimatedRank(yerlestirmePuani, rankingData["2023"]);
                const estimatedRank2022 = getEstimatedRank(yerlestirmePuani, rankingData["2022"]);

                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <p><strong>TYT Ham Puanınız (Yaklaşık):</strong> <span class="rank">${gorunenHamPuan.toFixed(3)}</span></p>
                    ${obpPuan > 0 ? `<p><strong>TYT Yerleştirme Puanınız (Yaklaşık):</strong> <span class="rank">${yerlestirmePuani.toFixed(3)}</span></p>` : ''}
                    <hr>
                    <h4>Bu Puanın Yıllara Göre Tahmini Sıralama Karşılıkları:</h4>
                    <ul>
                        <li><strong>2024 Yılı Tahmini Sıralama:</strong> ${estimatedRank2024}</li>
                        <li><strong>2023 Yılı Tahmini Sıralama:</strong> ${estimatedRank2023}</li>
                        <li><strong>2022 Yılı Tahmini Sıralama:</strong> ${estimatedRank2022}</li>
                    </ul>
                    <p style="font-size:0.8em; color:#555; margin-top:10px;">
                        *Sıralama tahminleri, ilgili yıllardaki sınav zorlukları ve yığılmalara dayalı bir yaklaşımdır. Kesinlik taşımaz ve sadece stratejik bir fikir vermesi amaçlanmıştır.
                    </p>
                `;
            });

            resetCalcBtn.addEventListener('click', function() {
                Object.keys(inputs).forEach(ders => {
                    inputs[ders].net.value = '';
                    inputs[ders].dogru.style.borderColor = '';
                    inputs[ders].yanlis.style.borderColor = '';
                });
                resultsDiv.style.display = 'none';
            });
    });
    </script>
</body>
</html>
